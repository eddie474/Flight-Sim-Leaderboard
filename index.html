<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Sim Score Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React and Babel for JSX compilation -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom Styles for Inter Font and Background -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; }
        #root {
            display: flex;
            min-height: 100vh;
            flex-direction: column;
            align-items: center;
        }
        /* Custom scrollbar for aesthetics */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase Modular SDK v11 Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose modular functions globally for the React/Babel script block
        window.fbs = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, collection, onSnapshot, addDoc, serverTimestamp, setLogLevel
        };
        
        // Set debug logging for Firestore as mandated
        window.fbs.setLogLevel('debug');
    </script>


    <script type="text/babel">
        // --- 1. Global Constants and Utilities ---
        
        const { useState, useEffect, useMemo } = React;
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, onSnapshot, addDoc, serverTimestamp } = window.fbs || {};

        // Configuration setup - prioritize environment variables
        let firebaseConfig = {
            apiKey: "REPLACE_WITH_YOUR_API_KEY", 
            authDomain: "REPLACE_WITH_YOUR_AUTH_DOMAIN",
            projectId: "REPLACE_WITH_YOUR_PROJECT_ID",
            storageBucket: "REPLACE_WITH_YOUR_STORAGE_BUCKET",
            messagingSenderId: "REPLACE_WITH_YOUR_MESSAGING_SENDER_ID",
            appId: "REPLACE_WITH_YOUR_APP_ID"
        };
        let appId = 'flightsim-leaderboard-public';
        let initialAuthToken = null;

        // CRITICAL FIX: Check if environment variables are present and override the dummies
        if (typeof __firebase_config !== 'undefined' && JSON.parse(__firebase_config).projectId) {
            Object.assign(firebaseConfig, JSON.parse(__firebase_config));
            appId = typeof __app_id !== 'undefined' ? __app_id : 'flightsim-leaderboard-default';
            initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        }
        
        // CRITICAL: Replace this with YOUR user ID (found in the footer when you load the app)
        const ADMIN_UID = "7QmxyVpRYmPWmSNiBQtYRIit7wh1";

        const COLLECTIONS = {
            STUDENTS: 'students',
            SCORES: 'scores',
            CHALLENGES: 'challenges',
        };

        const CATEGORIES = [
            { id: 'gt1', name: 'Ground Trainer 1', description: 'Focuses on core landing skills.' },
            { id: 'gt2', name: 'Ground Trainer 2', description: 'Advanced challenges with tricky conditions.' },
        ];

        const LoadingSpinner = () => (
            <div className="flex justify-center items-center p-8">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-400"></div>
                <p className="ml-3 text-emerald-300">Loading data...</p>
            </div>
        );

        const formatScore = (score) => {
            if (score === 0) return 'N/A';
            return score.toLocaleString('en-US');
        };

        // --- 2. Firebase Access Setup (Modular V9/V11) ---

        const useFirebaseSetup = () => {
            const [auth, setAuth] = useState(null);
            const [db, setDb] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);

            useEffect(() => {
                if (!initializeApp || !getAuth || !getFirestore) {
                    console.error("Firebase Modular SDKs not initialized properly.");
                    setIsAuthReady(true);
                    return;
                }

                if (!firebaseConfig.projectId || firebaseConfig.projectId.includes("REPLACE_WITH")) {
                    setIsAuthReady(true); 
                    return;
                }
                
                let appInstance, currentAuth, currentDb;
                try {
                    // Initialize app
                    appInstance = initializeApp(firebaseConfig);
                    currentAuth = getAuth(appInstance);
                    currentDb = getFirestore(appInstance);
                    
                    setAuth(currentAuth);
                    setDb(currentDb);
                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                    setIsAuthReady(true);
                    return;
                }

                // Authentication and User ID setup
                const authenticate = async (authInstance) => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(authInstance, initialAuthToken);
                        } else {
                            await signInAnonymously(authInstance);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error during sign-in:", error);
                    }
                };

                // Listen for Auth state changes
                const unsubscribe = onAuthStateChanged(currentAuth, (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        authenticate(currentAuth);
                    }
                    setIsAuthReady(true);
                });

                return () => unsubscribe();
            }, []);

            return { db, auth, userId, isAuthReady };
        };


        // --- 3. Data Fetching and Logic Hooks (Modular V9/V11) ---

        const useFirestoreData = (db, auth, userId) => {
            const [students, setStudents] = useState([]);
            const [scores, setScores] = useState([]);
            const [challenges, setChallenges] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                // Check if DB is initialized AND the user is signed in
                if (!db || !userId) {
                    if (db && firebaseConfig.projectId.includes("REPLACE_WITH")) {
                        setLoading(false);
                    }
                    return;
                }

                setLoading(true);

                // Helper for modular collection reference
                const getCollectionRef = (collectionName) => collection(db, `artifacts/${appId}/public/data/${collectionName}`);

                // Listeners for real-time updates (onSnapshot modular)
                const unsubscribeStudents = onSnapshot(getCollectionRef(COLLECTIONS.STUDENTS), (snapshot) => {
                    setStudents(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (error) => { console.error("Error fetching students:", error); });

                const unsubscribeScores = onSnapshot(getCollectionRef(COLLECTIONS.SCORES), (snapshot) => {
                    const scoreList = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        score: Number(doc.data().score) // Ensure score is a number
                    }));
                    setScores(scoreList);
                }, (error) => { console.error("Error fetching scores:", error); });

                const unsubscribeChallenges = onSnapshot(getCollectionRef(COLLECTIONS.CHALLENGES), (snapshot) => {
                    setChallenges(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching challenges:", error);
                    setLoading(false);
                });

                return () => {
                    unsubscribeStudents();
                    unsubscribeScores();
                    unsubscribeChallenges();
                };
            }, [db, userId]);

            return { students, scores, challenges, loading };
        };

        const useCategoryLeaderboard = (students, scores, challenges, categoryId) => {
            return useMemo(() => {
                // 1. Find all challenge IDs belonging to this category
                const challengeIdsInThisCategory = challenges
                    .filter(c => c.categoryId === categoryId)
                    .map(c => c.id);

                // 2. Filter scores relevant to these challenge IDs
                const filteredScores = scores.filter(score => challengeIdsInThisCategory.includes(score.challengeId));

                // 3. Find the highest score per student
                const studentHighScores = filteredScores.reduce((acc, score) => {
                    if (score.studentId) {
                        // Check if the current score is higher than the existing high score
                        if (!acc[score.studentId] || score.score > acc[score.studentId].score) {
                            acc[score.studentId] = {
                                score: score.score,
                                // Firestore timestamps are stored differently in V9 (can be Timestamp object or object with seconds/nanoseconds)
                                timestamp: score.timestamp, 
                                studentId: score.studentId,
                            };
                        }
                    }
                    return acc;
                }, {});

                // 4. Build the leaderboard, only including students with scores
                const leaderboard = students.map(student => {
                    const highScoreData = studentHighScores[student.id] || { score: 0, timestamp: null };
                    return {
                        id: student.id,
                        name: student.name,
                        highScore: highScoreData.score,
                        lastUpdated: highScoreData.timestamp,
                    };
                }).filter(item => item.highScore > 0);

                // 5. Sort the leaderboard (Highest score first, then newest timestamp)
                leaderboard.sort((a, b) => {
                    if (b.highScore !== a.highScore) {
                        return b.highScore - a.highScore;
                    }
                    // Extract seconds for comparison, handling null/undefined safely
                    const timeA = a.lastUpdated && a.lastUpdated.seconds ? a.lastUpdated.seconds : 0;
                    const timeB = b.lastUpdated && b.lastUpdated.seconds ? b.lastUpdated.seconds : 0;
                    return timeB - timeA;
                });

                return leaderboard;
            }, [students, scores, challenges, categoryId]);
        };

        // --- 4. View Components ---

        const CategoryLeaderboardCard = ({ category, students, scores, challenges, loading }) => {
            const leaderboard = useCategoryLeaderboard(students, scores, challenges, category.id);
            const associatedChallenges = challenges.filter(c => c.categoryId === category.id);

            // Limit challenge names shown in the footer for cleaner display
            const challengeList = associatedChallenges.map(c => c.name);
            const challengeDisplay = challengeList.length > 3
                ? `${challengeList.slice(0, 3).join(', ')} and ${challengeList.length - 3} more...`
                : challengeList.join(', ');

            return (
                <div className="bg-gray-700/50 p-5 rounded-xl shadow-lg h-full flex flex-col">
                    <h3 className="text-2xl font-extrabold text-emerald-300 mb-1 border-b border-gray-600 pb-2">{category.name}</h3>
                    <p className="text-sm text-gray-400 mb-4 italic">{category.description}</p>

                    {loading ? <LoadingSpinner /> : (
                        <div className="space-y-2 flex-grow min-h-[200px] overflow-y-auto">
                            <div className="sticky top-0 bg-gray-700/80 grid grid-cols-12 font-bold text-gray-400 py-2 border-b border-gray-500 z-10">
                                <div className="col-span-2 text-center">#</div>
                                <div className="col-span-6">Pilot</div>
                                <div className="col-span-4 text-right">Best Score</div>
                            </div>
                            {leaderboard.length === 0 ? (
                                <p className="text-center text-gray-400 p-4 text-sm">
                                    No scores recorded yet for any challenge in this category.
                                </p>
                            ) : (
                                leaderboard.map((student, index) => (
                                    <div key={student.id} className="grid grid-cols-12 items-center py-2 px-1 rounded transition duration-200 hover:bg-gray-700"
                                        style={{
                                            backgroundColor: index === 0 ? 'rgba(52, 211, 163, 0.1)' :
                                                                         index === 1 ? 'rgba(96, 165, 250, 0.1)' :
                                                                         index === 2 ? 'rgba(251, 191, 36, 0.1)' :
                                                                         'transparent',
                                        }}
                                    >
                                        <div className="col-span-2 text-center font-bold"
                                            style={{ color: index === 0 ? '#34d399' : index === 1 ? '#60a5fa' : index === 2 ? '#f59e0b' : '#a7f3d0' }}
                                        >
                                            {index + 1}
                                        </div>
                                        <div className="col-span-6 text-gray-200 text-sm truncate">{student.name}</div>
                                        <div className="col-span-4 text-right text-sm font-mono text-white">{formatScore(student.highScore)}</div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}
                    <div className="mt-4 pt-3 border-t border-gray-600 text-xs text-gray-500">
                        Challenges contributing: {challengeDisplay || 'None defined'}
                    </div>
                </div>
            );
        }

        const LeaderboardsView = ({ students, scores, challenges, loading }) => {
            // Check if we failed to initialize firebase (due to missing config)
            if (!firebaseConfig.projectId || firebaseConfig.projectId.includes("REPLACE_WITH")) {
                return (
                    <div className="w-full max-w-7xl p-8 bg-red-900/50 backdrop-blur-sm rounded-xl shadow-2xl text-center">
                        <h2 className="text-3xl font-extrabold mb-4 text-red-300">Configuration Error</h2>
                        <p className="text-lg text-red-200">
                            The Firebase configuration keys are missing. Please edit the **index.html** file around line 40 and replace the placeholder values with your actual Firebase project configuration (API Key, Project ID, etc.).
                        </p>
                    </div>
                );
            }

            return (
                <div className="w-full max-w-7xl p-4 md:p-8 bg-gray-800/80 backdrop-blur-sm rounded-xl shadow-2xl">
                    <h2 className="text-3xl font-extrabold mb-8 text-emerald-400 border-b border-emerald-500/50 pb-2 flex items-center justify-center">
                        <svg className="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19V6l12-3v14M9 19a2 2 0 002 2h2a2 2 0 002-2M9 19c0 1.105.9 2 2 2h2c1.105 0 2-.895 2-2M9 19v-6M15 19v-6"></path></svg>
                        Ground Trainer Leaderboards Overview
                    </h2>

                    {loading ? <LoadingSpinner /> : (
                        <div className="grid grid-cols-1 gap-6 lg:grid-cols-2">
                            {CATEGORIES.map(category => (
                                <CategoryLeaderboardCard
                                    key={category.id}
                                    category={category}
                                    students={students}
                                    scores={scores}
                                    challenges={challenges}
                                    loading={loading}
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- Admin Content (The actual forms and logic - Modular V9/V11) ---
        const AdminViewContent = ({ db, userId, students, challenges, loading }) => {
            // State for forms
            const [newStudentName, setNewStudentName] = useState('');
            const [newChallengeCategory, setNewChallengeCategory] = useState(CATEGORIES[0].id);
            const [newChallengeName, setNewChallengeName] = useState('');
            const [newChallengeAirport, setNewChallengeAirport] = useState('');
            const [selectedStudentId, setSelectedStudentId] = useState('');
            const [newScore, setNewScore] = useState('');
            const [selectedChallengeId, setSelectedChallengeId] = useState('');
            const [message, setMessage] = useState('');

            // Update selectors when data loads
            useEffect(() => {
                if (students.length > 0 && !selectedStudentId) {
                    setSelectedStudentId(students[0].id);
                }
                if (challenges.length > 0 && !selectedChallengeId) {
                    setSelectedChallengeId(challenges[0].id);
                }
            }, [students, challenges]);


            const studentOptions = students.map(s => <option key={s.id} value={s.id}>{s.name}</option>);
            const categoryOptions = CATEGORIES.map(c => <option key={c.id} value={c.id}>{c.name}</option>);

            // Admin Functions (Modularized)
            const handleAddChallenge = async (e) => {
                e.preventDefault();
                if (!db || !newChallengeName.trim() || !newChallengeAirport.trim() || !newChallengeCategory) return;

                try {
                    const category = CATEGORIES.find(c => c.id === newChallengeCategory);
                    const challengesRef = collection(db, `artifacts/${appId}/public/data/${COLLECTIONS.CHALLENGES}`);
                    await addDoc(challengesRef, {
                        name: newChallengeName.trim(),
                        airport: newChallengeAirport.trim(),
                        categoryId: newChallengeCategory,
                        categoryName: category.name,
                        createdById: userId,
                        createdAt: serverTimestamp(),
                    });
                    setNewChallengeName('');
                    setNewChallengeAirport('');
                    setMessage(`Successfully added challenge: ${newChallengeName.trim()} for ${category.name}`);
                    setTimeout(() => setMessage(''), 3000);
                } catch (error) {
                    console.error("Error adding challenge:", error);
                    setMessage(`Error adding challenge: ${error.message}`);
                    setTimeout(() => setMessage(''), 5000);
                }
            };


            const handleAddStudent = async (e) => {
                e.preventDefault();
                if (!db || !newStudentName.trim()) return;

                try {
                    const studentsRef = collection(db, `artifacts/${appId}/public/data/${COLLECTIONS.STUDENTS}`);
                    await addDoc(studentsRef, {
                        name: newStudentName.trim(),
                        createdById: userId,
                        createdAt: serverTimestamp(),
                    });
                    setNewStudentName('');
                    setMessage(`Successfully added pilot: ${newStudentName.trim()}`);
                    setTimeout(() => setMessage(''), 3000);
                } catch (error) {
                    console.error("Error adding student:", error);
                    setMessage(`Error adding pilot: ${error.message}`);
                    setTimeout(() => setMessage(''), 5000);
                }
            };

            const handleAddScore = async (e) => {
                e.preventDefault();
                if (!db || !selectedStudentId || !selectedChallengeId || isNaN(parseInt(newScore))) return;

                const student = students.find(s => s.id === selectedStudentId);
                const challenge = challenges.find(c => c.id === selectedChallengeId);
                if (!student || !challenge) {
                    setMessage("Error: Pilot or Challenge not found. Please check data and refresh.");
                    setTimeout(() => setMessage(''), 3000);
                    return;
                }

                try {
                    const scoresRef = collection(db, `artifacts/${appId}/public/data/${COLLECTIONS.SCORES}`);
                    await addDoc(scoresRef, {
                        studentId: selectedStudentId,
                        name: student.name,
                        score: parseInt(newScore, 10),
                        challengeId: selectedChallengeId,
                        challengeName: challenge.name,
                        categoryId: challenge.categoryId,
                        uploadedById: userId,
                        timestamp: serverTimestamp(),
                    });
                    setNewScore('');
                    setMessage(`Score of ${parseInt(newScore, 10).toLocaleString()} recorded for ${student.name} in ${challenge.name}!`);
                    setTimeout(() => setMessage(''), 3000);
                } catch (error) {
                    console.error("Error adding score:", error);
                    setMessage(`Error adding score: ${error.message}`);
                    setTimeout(() => setMessage(''), 5000);
                }
            };

            return (
                <div className="w-full max-w-4xl p-4 md:p-8 bg-gray-800/80 backdrop-blur-sm rounded-xl shadow-2xl text-white space-y-8">
                    <h2 className="text-3xl font-extrabold text-blue-400 border-b border-blue-500/50 pb-2 flex items-center">
                        <svg className="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.222.08 2.573-1.066z"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Admin Panel - Tools
                    </h2>

                    {loading ? <LoadingSpinner /> : (
                        <>
                            {message && (
                                <div className="bg-green-600 p-3 rounded mb-4 text-center font-semibold animate-pulse">
                                    {message}
                                </div>
                            )}

                            {/* 1. Define New Challenge Section */}
                            <div className="border border-gray-600 p-4 rounded-lg bg-gray-700/30">
                                <h3 className="text-xl font-bold mb-3 text-blue-300">1. Define New Landing Challenge</h3>
                                <form onSubmit={handleAddChallenge} className="flex flex-col gap-4">
                                    <label htmlFor="category-select-admin" className="block text-sm font-medium text-gray-400">Select Category</label>
                                    <select
                                        id="category-select-admin"
                                        value={newChallengeCategory}
                                        onChange={(e) => setNewChallengeCategory(e.target.value)}
                                        className="p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white"
                                        required
                                        disabled={loading}
                                    >
                                        {categoryOptions}
                                    </select>
                                    <input
                                        type="text"
                                        placeholder="Challenge Name (e.g., Courchevel Landing)"
                                        value={newChallengeName}
                                        onChange={(e) => setNewChallengeName(e.target.value)}
                                        className="p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white"
                                        required
                                        disabled={loading}
                                    />
                                    <input
                                        type="text"
                                        placeholder="Airport Code (e.g., LFLJ)"
                                        value={newChallengeAirport}
                                        onChange={(e) => setNewChallengeAirport(e.target.value)}
                                        className="p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white"
                                        required
                                        disabled={loading}
                                    />
                                    <button
                                        type="submit"
                                        className="w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md transition duration-150 shadow-md disabled:opacity-50"
                                        disabled={loading || !newChallengeName.trim() || !newChallengeAirport.trim() || !newChallengeCategory}
                                    >
                                        Create Challenge
                                    </button>
                                </form>
                            </div>

                            {/* 2. Add Pilot Section */}
                            <div className="border border-gray-600 p-4 rounded-lg bg-gray-700/30">
                                <h3 className="text-xl font-bold mb-3 text-gray-200">2. Add New Pilot</h3>
                                <form onSubmit={handleAddStudent} className="flex flex-col sm:flex-row gap-4">
                                    <input
                                        type="text"
                                        placeholder="Student Name / Pilot Callsign"
                                        value={newStudentName}
                                        onChange={(e) => setNewStudentName(e.target.value)}
                                        className="flex-grow p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-emerald-500 focus:border-emerald-500 text-white"
                                        required
                                        disabled={loading}
                                    />
                                    <button
                                        type="submit"
                                        className="w-full sm:w-auto px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-md transition duration-150 shadow-md disabled:opacity-50"
                                        disabled={loading || !newStudentName.trim()}
                                    >
                                        Add Pilot
                                    </button>
                                </form>
                            </div>

                            {/* 3. Upload Score Section */}
                            <div className="border border-gray-600 p-4 rounded-lg bg-gray-700/30">
                                <h3 className="text-xl font-bold mb-3 text-gray-200">3. Upload New Landing Score</h3>
                                <form onSubmit={handleAddScore} className="space-y-4">
                                    {/* Challenge Selector */}
                                    <div>
                                        <label htmlFor="challenge-select" className="block text-sm font-medium text-gray-400 mb-1">Select Specific Challenge</label>
                                        <select
                                            id="challenge-select"
                                            value={selectedChallengeId}
                                            onChange={(e) => setSelectedChallengeId(e.target.value)}
                                            className="w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white"
                                            required
                                            disabled={loading || challenges.length === 0}
                                        >
                                            <option value="" disabled>-- Choose a challenge --</option>
                                            {challenges.map(c => <option key={c.id} value={c.id}>{c.name} ({c.airport}) - {c.categoryName}</option>)}
                                        </select>
                                        {challenges.length === 0 && !loading && (
                                            <p className="text-sm text-red-400 mt-2">No challenges defined. Please create one in Section 1.</p>
                                        )}
                                    </div>

                                    {/* Pilot Selector */}
                                    <div>
                                        <label htmlFor="student-select" className="block text-sm font-medium text-gray-400 mb-1">Select Pilot</label>
                                        <select
                                            id="student-select"
                                            value={selectedStudentId}
                                            onChange={(e) => setSelectedStudentId(e.target.value)}
                                            className="w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-emerald-500 focus:border-emerald-500 text-white"
                                            required
                                            disabled={loading || students.length === 0}
                                        >
                                            <option value="" disabled>-- Choose a pilot --</option>
                                            {studentOptions}
                                        </select>
                                        {students.length === 0 && !loading && (
                                            <p className="text-sm text-red-400 mt-2">No pilots available. Please add a pilot in Section 2.</p>
                                        )}
                                    </div>

                                    {/* Score Input */}
                                    <div>
                                        <label htmlFor="score-input" className="block text-sm font-medium text-gray-400 mb-1">Landing Score (e.g., 985000)</label>
                                        <input
                                            id="score-input"
                                            type="number"
                                            placeholder="Enter score"
                                            value={newScore}
                                            onChange={(e) => setNewScore(e.target.value)}
                                            className="w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-emerald-500 focus:border-emerald-500 text-white font-mono"
                                            required
                                            min="1"
                                            disabled={loading || !selectedStudentId || !selectedChallengeId}
                                        />
                                    </div>
                                    <button
                                        type="submit"
                                        className="w-full px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-md transition duration-150 shadow-md disabled:opacity-50"
                                        disabled={loading || !selectedStudentId || !selectedChallengeId || !newScore || parseInt(newScore) <= 0}
                                    >
                                        Submit Score
                                    </button>
                                </form>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        // --- Admin Access Control (Simplified) ---
        const AdminView = (props) => {
            const { userId, loading } = props;

            // Check if Firebase config is still using placeholders
            if (firebaseConfig.projectId.includes("REPLACE_WITH")) {
                return (
                    <div className="w-full max-w-md p-8 bg-red-900/50 backdrop-blur-sm rounded-xl shadow-2xl text-white space-y-6">
                        <h2 className="text-3xl font-extrabold text-red-300 text-center">Configuration Required</h2>
                        <p className="text-gray-300 text-center">
                            Admin access requires proper Firebase setup. Please update the configuration first.
                        </p>
                    </div>
                );
            }

            // Check if the current user ID matches the defined Admin UID
            if (userId !== ADMIN_UID) {
                return (
                    <div className="w-full max-w-md p-8 bg-red-900/50 backdrop-blur-sm rounded-xl shadow-2xl text-white space-y-6">
                        <h2 className="text-3xl font-extrabold text-red-300 text-center">Admin Access Denied</h2>
                        <p className="text-gray-300 text-center">
                            This panel is restricted. Your current User ID does not match the Admin ID in the code.
                        </p>
                    </div>
                );
            }

            // If authenticated and authorized, show the content.
            return <AdminViewContent {...props} />;
        };


        const App = () => {
            const [view, setView] = useState('leaderboard');

            // Centralized Firebase setup via custom hook
            const { db, auth, userId, isAuthReady } = useFirebaseSetup();

            // Data fetching hook depends on successful Firebase/Auth initialization
            const { students, scores, challenges, loading: dataLoading } = useFirestoreData(db, auth, userId);

            // True loading state includes both Auth readiness and data fetching
            const loading = !isAuthReady || dataLoading;

            return (
                <div className="min-h-screen bg-gray-900 font-sans text-gray-100 p-4 flex flex-col items-center">

                    {/* Header and Navigation */}
                    <header className="w-full max-w-7xl mb-8">
                        <h1 className="text-4xl font-black text-center text-white p-4">
                            <span className="text-emerald-400">Flight Sim</span> Score Tracker
                        </h1>
                        <div className="flex justify-center space-x-4">
                            <button
                                onClick={() => setView('leaderboard')}
                                className={`px-6 py-2 rounded-full font-semibold transition duration-200 ${
                                    view === 'leaderboard'
                                        ? 'bg-emerald-600 text-white shadow-lg'
                                        : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                }`}
                            >
                                Leaderboards Overview
                            </button>
                            <button
                                onClick={() => setView('admin')}
                                className={`px-6 py-2 rounded-full font-semibold transition duration-200 ${
                                    view === 'admin'
                                        ? 'bg-blue-600 text-white shadow-lg'
                                        : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                }`}
                            >
                                Admin Panel (Secured)
                            </button>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="w-full flex justify-center">
                        {/* Display error message if configuration is missing */}
                        {!loading && firebaseConfig.projectId.includes("REPLACE_WITH") ? (
                            <LeaderboardsView students={[]} scores={[]} challenges={[]} loading={true} /> // Renders the config error box
                        ) : loading ? (
                            <LoadingSpinner />
                        ) : (
                            view === 'leaderboard' ? (
                                <LeaderboardsView
                                    students={students}
                                    scores={scores}
                                    challenges={challenges}
                                    loading={dataLoading}
                                />
                            ) : (
                                <AdminView
                                    db={db}
                                    userId={userId}
                                    students={students}
                                    challenges={challenges}
                                    loading={dataLoading}
                                />
                            )
                        )}
                    </main>

                    {/* Footer / Debug Info */}
                    <footer className="mt-8 text-center text-xs text-gray-500 max-w-7xl">
                        <p>App ID: {appId}</p>
                        <p>Current User ID: {userId || 'Authenticating...'}</p>
                    </footer>
                </div>
            );
        };

        // Final render call
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
