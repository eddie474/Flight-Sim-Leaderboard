<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Sim Score Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React and Babel for JSX compilation -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Custom Styles for Inter Font and Background -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #FFFFFF; }
        #root {
            display: flex;
            min-height: 100vh;
            flex-direction: column;
            align-items: center;
        }
        /* Custom scrollbar for aesthetics */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. Global Constants and Utilities ---
        
        // Firebase Configuration (KEYS PASTE AREA)
        let firebaseConfig = {
            // ===================================================================
            // !!! YOUR FIREBASE CONFIGURATION IS HERE !!!
            // ===================================================================
            apiKey: "AIzaSyAK1umts0wkVAkCWqtQ_04DQcto78jbZaE",
            authDomain: "flight-sim-leaderboard.firebaseapp.com",
            projectId: "flight-sim-leaderboard",
            storageBucket: "flight-sim-leaderboard.firebasestorage.app",
            messagingSenderId: "1045910945297",
            appId: "1:1045910945297:web:39417042ebdf9eda0bbbb0"
        }; 
        let appId = 'flightsim-leaderboard-public'; // Default public App ID
        let initialAuthToken = null; // Custom tokens are not available in public deployment
        
        // CRITICAL FIX: Check if environment variables are present and override the dummies (for Canvas use)
        if (typeof __firebase_config !== 'undefined' && JSON.parse(__firebase_config).projectId) {
            Object.assign(firebaseConfig, JSON.parse(__firebase_config));
            appId = typeof __app_id !== 'undefined' ? __app_id : 'flightsim-leaderboard-default';
            initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        }

        const { useState, useEffect, useMemo } = React;

        const COLLECTIONS = {
            STUDENTS: 'students',
            SCORES: 'scores',
            CHALLENGES: 'challenges', 
        };

        const CATEGORIES = [
            { id: 'gt1', name: 'Ground Trainer 1', description: 'Focuses on core landing skills.' },
            { id: 'gt2', name: 'Ground Trainer 2', description: 'Advanced challenges with tricky conditions.' },
        ];
        
        const LoadingSpinner = () => (
            <div className="flex justify-center items-center p-8">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-400"></div>
                <p className="ml-3 text-emerald-300">Loading data...</p>
            </div>
        );

        const formatScore = (score) => {
            if (score === 0) return 'N/A';
            return score.toLocaleString('en-US');
        };

        // --- 2. Firebase Access Setup ---
        // These functions map to the globally loaded Firebase SDK (v8 syntax)

        const getAppInstance = (config) => {
            // Ensure Firebase SDK is available before accessing window.firebase
            if (typeof window.firebase === 'undefined') {
                console.error("Firebase SDK not found.");
                return null;
            }

            if (window.firebase.apps.length > 0) {
                return window.firebase.app();
            }
            // Check if config keys are valid before initializing
            if (!config || !config.projectId || config.projectId.includes("REPLACE_WITH")) {
                 console.error("FIREBASE ERROR: Configuration missing or invalid.");
                 return null; 
            }
            return window.firebase.initializeApp(config);
        };

        const useFirebaseSetup = () => {
            const [auth, setAuth] = useState(null);
            const [db, setDb] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);

            useEffect(() => {
                if (typeof window.firebase === 'undefined') {
                    console.error("Firebase SDK not found.");
                    setIsAuthReady(true);
                    return;
                }
                
                let app, currentAuth, currentDb;
                try {
                    app = getAppInstance(firebaseConfig);
                    if (!app) {
                        setIsAuthReady(true);
                        return;
                    }

                    currentAuth = app.auth();
                    currentDb = app.firestore();
                    setAuth(currentAuth);
                    setDb(currentDb);
                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                    setIsAuthReady(true);
                    return;
                }

                // Authentication and User ID setup
                const authenticate = async () => {
                    try {
                        if (initialAuthToken) {
                            await currentAuth.signInWithCustomToken(initialAuthToken);
                        } else {
                            await currentAuth.signInAnonymously();
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error during sign-in:", error);
                    }
                };

                const unsubscribe = currentAuth.onAuthStateChanged((user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        authenticate();
                    }
                    setIsAuthReady(true);
                });

                return () => unsubscribe();
            }, []);

            return { db, auth, userId, isAuthReady };
        };


        // --- 3. Data Fetching and Logic Hooks ---

        const useFirestoreData = (db, auth, userId) => {
            const [students, setStudents] = useState([]);
            const [scores, setScores] = useState([]);
            const [challenges, setChallenges] = useState([]); 
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                // Check if Firestore is ready and the user is authenticated/ready
                if (!db || !userId) {
                    if (db && firebaseConfig.projectId.includes("REPLACE_WITH")) {
                        setLoading(false); 
                        return;
                    }
                    return;
                }

                setLoading(true);

                // Helper to get the correct public collection reference
                const getCollectionRef = (collectionName) => db.collection(`artifacts/${appId}/public/data/${collectionName}`);

                const studentsRef = getCollectionRef(COLLECTIONS.STUDENTS);
                const scoresRef = getCollectionRef(COLLECTIONS.SCORES);
                const challengesRef = getCollectionRef(COLLECTIONS.CHALLENGES);

                // Listeners for real-time updates
                const unsubscribeStudents = studentsRef.onSnapshot((snapshot) => {
                    setStudents(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (error) => { console.error("Error fetching students:", error); });

                const unsubscribeScores = scoresRef.onSnapshot((snapshot) => {
                    const scoreList = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        score: Number(doc.data().score) // Ensure score is a number
                    }));
                    setScores(scoreList);
                }, (error) => { console.error("Error fetching scores:", error); });
                
                const unsubscribeChallenges = challengesRef.onSnapshot((snapshot) => {
                    setChallenges(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false); 
                }, (error) => {
                    console.error("Error fetching challenges:", error);
                    setLoading(false);
                });

                // Cleanup function to detach listeners
                return () => {
                    unsubscribeStudents();
                    unsubscribeScores();
                };
            }, [db, userId]);

            return { students, scores, challenges, loading };
        };

        // Hook to calculate the highest score per student for a given category
        const useCategoryLeaderboard = (students, scores, challenges, categoryId) => {
            return useMemo(() => {
                // 1. Filter challenge IDs belonging to this category
                const challengeIdsInThisCategory = challenges
                    .filter(c => c.categoryId === categoryId)
                    .map(c => c.id);

                // 2. Filter scores relevant to these challenges
                const filteredScores = scores.filter(score => challengeIdsInThisCategory.includes(score.challengeId));

                // 3. Find the single highest score for each student across all relevant challenges
                const studentHighScores = filteredScores.reduce((acc, score) => {
                    if (score.studentId) {
                        // Check if this score is better than the current recorded high score
                        if (!acc[score.studentId] || score.score > acc[score.studentId].score) {
                            acc[score.studentId] = {
                                score: score.score,
                                timestamp: score.timestamp,
                            };
                        }
                    }
                    return acc;
                }, {});

                // 4. Combine student names with their best score and filter out students with no scores
                const leaderboard = students.map(student => {
                    const highScoreData = studentHighScores[student.id] || { score: 0, timestamp: null };
                    return {
                        id: student.id,
                        name: student.name,
                        highScore: highScoreData.score,
                        lastUpdated: highScoreData.timestamp,
                    };
                }).filter(item => item.highScore > 0); 

                // 5. Sort the final leaderboard (High score first, then newest timestamp)
                leaderboard.sort((a, b) => {
                    if (b.highScore !== a.highScore) {
                        return b.highScore - a.highScore; // Primary sort: Highest score first
                    }
                    // Secondary sort: Newest timestamp first (if scores are equal)
                    const timeA = a.lastUpdated?.seconds || 0;
                    const timeB = b.lastUpdated?.seconds || 0;
                    return timeB - timeA;
                });

                return leaderboard;
            }, [students, scores, challenges, categoryId]);
        };

        // --- 4. View Components ---

        const CategoryLeaderboardCard = ({ category, students, scores, challenges, loading }) => {
            const leaderboard = useCategoryLeaderboard(students, scores, challenges, category.id);
            const associatedChallenges = challenges.filter(c => c.categoryId === category.id);
            
            const challengeList = associatedChallenges.map(c => c.name);
            const challengeDisplay = challengeList.length > 3 
                ? `${challengeList.slice(0, 3).join(', ')} and ${challengeList.length - 3} more...` 
                : challengeList.join(', ');

            return (
                <div className="bg-gray-700/50 p-5 rounded-xl shadow-lg h-full flex flex-col">
                    <h3 className="text-2xl font-extrabold text-emerald-300 mb-1 border-b border-gray-600 pb-2">{category.name}</h3>
                    <p className="text-sm text-gray-400 mb-4 italic">{category.description}</p>
                    
                    {loading ? <LoadingSpinner /> : (
                        <div className="space-y-2 flex-grow min-h-[200px] overflow-y-auto">
                            <div className="sticky top-0 bg-gray-700/80 grid grid-cols-12 font-bold text-gray-400 py-2 border-b border-gray-500 z-10">
                                <div className="col-span-2 text-center">#</div>
                                <div className="col-span-6">Pilot</div>
                                <div className="col-span-4 text-right">Best Score</div>
                            </div>
                            {leaderboard.length === 0 ? (
                                <p className="text-center text-gray-400 p-4 text-sm">
                                    No scores recorded yet for any challenge in this category.
                                </p>
                            ) : (
                                leaderboard.map((student, index) => (
                                    <div key={student.id} className="grid grid-cols-12 items-center py-2 px-1 rounded transition duration-200 hover:bg-gray-700"
                                        style={{
                                            backgroundColor: index === 0 ? 'rgba(52, 211, 163, 0.1)' :
                                                             index === 1 ? 'rgba(96, 165, 250, 0.1)' :
                                                             index === 2 ? 'rgba(251, 191, 36, 0.1)' :
                                                             'transparent',
                                        }}
                                    >
                                        <div className="col-span-2 text-center font-bold"
                                            style={{ color: index === 0 ? '#34d399' : index === 1 ? '#60a5fa' : index === 2 ? '#f59e0b' : '#a7f3d0' }}
                                        >
                                            {index + 1}
                                        </div>
                                        <div className="col-span-6 text-gray-200 text-sm truncate">{student.name}</div>
                                        <div className="col-span-4 text-right text-sm font-mono text-white">{formatScore(student.highScore)}</div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}
                    <div className="mt-4 pt-3 border-t border-gray-600 text-xs text-gray-500">
                        Challenges contributing: {challengeDisplay || 'None defined'}
                    </div>
                </div>
            );
        }

        const LeaderboardsView = ({ students, scores, challenges, loading }) => {
            return (
                <div className="w-full max-w-7xl p-4 md:p-8 bg-gray-800/80 backdrop-blur-sm rounded-xl shadow-2xl">
                    <h2 className="text-3xl font-extrabold mb-8 text-emerald-400 border-b border-emerald-500/50 pb-2 flex items-center justify-center">
                        <svg className="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19V6l12-3v14M9 19a2 2 0 002 2h2a2 2 0 002-2M9 19c0 1.105.9 2 2 2h2c1.105 0 2-.895 2-2M9 19v-6M15 19v-6"></path></svg>
                        Ground Trainer Leaderboards Overview
                    </h2>

                    {loading ? <LoadingSpinner /> : (
                        <div className="grid grid-cols-1 gap-6 md:grid-cols-2">
                            {CATEGORIES.map(category => (
                                <CategoryLeaderboardCard
                                    key={category.id}
                                    category={category}
                                    students={students}
                                    scores={scores}
                                    challenges={challenges}
                                    loading={loading}
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        };
        
        // --- Admin Content (The actual forms and logic) ---
        // NOTE: Added 'scores' to props.
        const AdminViewContent = ({ db, userId, students, scores, challenges, loading }) => {
            // State for Adding Data
            const [newStudentName, setNewStudentName] = useState('');
            const [newChallengeCategory, setNewChallengeCategory] = useState(CATEGORIES[0].id);
            const [newChallengeName, setNewChallengeName] = useState('');
            const [newChallengeAirport, setNewChallengeAirport] = useState('');
            const [newScore, setNewScore] = useState('');

            // State for Uploading Data (Selectors for Add Score)
            const [selectedStudentId, setSelectedStudentId] = useState('');
            const [selectedChallengeId, setSelectedChallengeId] = useState('');

            // State for Deleting Data (Selectors) - NEW STATES
            const [selectedStudentIdToDelete, setSelectedStudentIdToDelete] = useState('');
            const [selectedChallengeIdToDelete, setSelectedChallengeIdToDelete] = useState('');
            const [selectedScoreIdToDelete, setSelectedScoreIdToDelete] = useState('');

            // Status/Error Messaging - Updated to handle error state
            const [message, setMessage] = useState('');
            const [error, setError] = useState('');

            // Helper function for status messages
            const setStatus = (msg, isError = false) => {
                isError ? setError(msg) : setMessage(msg);
                setTimeout(() => {
                    setMessage('');
                    setError('');
                }, 4000);
            };

            // Update selectors on initial load and data changes
            useEffect(() => {
                if (students.length > 0) {
                    if (!selectedStudentId) setSelectedStudentId(students[0].id);
                    if (!selectedStudentIdToDelete) setSelectedStudentIdToDelete(students[0].id);
                }
                if (challenges.length > 0) {
                    if (!selectedChallengeId) setSelectedChallengeId(challenges[0].id);
                    if (!selectedChallengeIdToDelete) setSelectedChallengeIdToDelete(challenges[0].id);
                }
                if (scores.length > 0 && !selectedScoreIdToDelete) {
                    setSelectedScoreIdToDelete(scores[0].id);
                }
            }, [students, challenges, scores]);


            // Helper to generate clean score display for the delete dropdown (sorted by score then time)
            const sortedScores = useMemo(() => {
                return [...scores].sort((a, b) => {
                    // Primary sort: Highest score first
                    if (b.score !== a.score) return b.score - a.score;
                    // Secondary sort: Newest timestamp first
                    const timeA = a.timestamp?.seconds || 0;
                    const timeB = b.timestamp?.seconds || 0;
                    return timeB - timeA;
                });
            }, [scores]);


            const studentOptions = students.map(s => <option key={s.id} value={s.id}>{s.name}</option>);
            const challengeOptions = challenges.map(c => <option key={c.id} value={c.id}>{c.name} ({c.airport}) - {c.categoryName}</option>);
            const categoryOptions = CATEGORIES.map(c => <option key={c.id} value={c.id}>{c.name}</option>);

            // --- ADD FUNCTIONS (Unmodified logic) ---

            const handleAddChallenge = async (e) => {
                e.preventDefault();
                if (!db || !newChallengeName.trim() || !newChallengeAirport.trim() || !newChallengeCategory) return;

                try {
                    const category = CATEGORIES.find(c => c.id === newChallengeCategory);
                    const challengesRef = db.collection(`artifacts/${appId}/public/data/${COLLECTIONS.CHALLENGES}`);
                    await challengesRef.add({
                        name: newChallengeName.trim(),
                        airport: newChallengeAirport.trim(),
                        categoryId: newChallengeCategory, 
                        categoryName: category.name,     
                        createdById: userId,
                        createdAt: window.firebase.firestore.FieldValue.serverTimestamp(),
                    });
                    setNewChallengeName('');
                    setNewChallengeAirport('');
                    setStatus(`Successfully added challenge: ${newChallengeName.trim()} for ${category.name}`);
                } catch (error) {
                    console.error("Error adding challenge:", error);
                    setStatus(`Error adding challenge: ${error.message}`, true);
                }
            };


            const handleAddStudent = async (e) => {
                e.preventDefault();
                if (!db || !newStudentName.trim()) return;

                try {
                    const studentsRef = db.collection(`artifacts/${appId}/public/data/${COLLECTIONS.STUDENTS}`);
                    await studentsRef.add({
                        name: newStudentName.trim(),
                        createdById: userId,
                        createdAt: window.firebase.firestore.FieldValue.serverTimestamp(),
                    });
                    setNewStudentName('');
                    setStatus(`Successfully added pilot: ${newStudentName.trim()}`);
                } catch (error) {
                    console.error("Error adding student:", error);
                    setStatus(`Error adding pilot: ${error.message}`, true);
                }
            };

            const handleAddScore = async (e) => {
                e.preventDefault();
                // Validate input fields
                if (!db || !selectedStudentId || !selectedChallengeId || isNaN(parseInt(newScore)) || parseInt(newScore) <= 0) return;

                const student = students.find(s => s.id === selectedStudentId);
                const challenge = challenges.find(c => c.id === selectedChallengeId);
                if (!student || !challenge) {
                    setStatus("Error: Pilot or Challenge not found. Please check data and refresh.", true);
                    return;
                }

                try {
                    const scoresRef = db.collection(`artifacts/${appId}/public/data/${COLLECTIONS.SCORES}`);
                    await scoresRef.add({
                        studentId: selectedStudentId,
                        name: student.name,
                        score: parseInt(newScore, 10),
                        challengeId: selectedChallengeId,
                        challengeName: challenge.name,
                        categoryId: challenge.categoryId, 
                        uploadedById: userId,
                        timestamp: window.firebase.firestore.FieldValue.serverTimestamp(),
                    });
                    setNewScore('');
                    setStatus(`Score of ${parseInt(newScore, 10).toLocaleString()} recorded for ${student.name} in ${challenge.name}!`);
                } catch (error) {
                    console.error("Error adding score:", error);
                    setStatus(`Error adding score: ${error.message}`, true);
                }
            };

            // --- DELETE FUNCTIONS ---

            const handleDeleteStudent = async (e) => {
                e.preventDefault();
                if (!db || !selectedStudentIdToDelete) return;

                const studentName = students.find(s => s.id === selectedStudentIdToDelete)?.name || 'Unknown Pilot';
                const studentDocRef = db.collection(`artifacts/${appId}/public/data/${COLLECTIONS.STUDENTS}`).doc(selectedStudentIdToDelete);

                try {
                    await studentDocRef.delete();
                    // Warn user that scores are not cascade deleted in Firestore
                    setStatus(`Successfully removed pilot: ${studentName}. (Note: Related scores must be removed manually.)`);
                    setSelectedStudentIdToDelete('');
                } catch (error) {
                    console.error("Error deleting student:", error);
                    setStatus(`Error removing pilot: ${error.message}`, true);
                }
            };

            const handleDeleteChallenge = async (e) => {
                e.preventDefault();
                if (!db || !selectedChallengeIdToDelete) return;

                const challengeName = challenges.find(c => c.id === selectedChallengeIdToDelete)?.name || 'Unknown Challenge';
                const challengeDocRef = db.collection(`artifacts/${appId}/public/data/${COLLECTIONS.CHALLENGES}`).doc(selectedChallengeIdToDelete);

                try {
                    await challengeDocRef.delete();
                    setStatus(`Successfully removed challenge: ${challengeName}. (Note: Related scores must be removed manually.)`);
                    setSelectedChallengeIdToDelete('');
                } catch (error) {
                    console.error("Error deleting challenge:", error);
                    setStatus(`Error removing challenge: ${error.message}`, true);
                }
            };

            const handleDeleteScore = async (e) => {
                e.preventDefault();
                if (!db || !selectedScoreIdToDelete) return;

                const scoreEntry = scores.find(s => s.id === selectedScoreIdToDelete);
                const scoreDocRef = db.collection(`artifacts/${appId}/public/data/${COLLECTIONS.SCORES}`).doc(selectedScoreIdToDelete);
                const scoreDisplay = scoreEntry ? `${scoreEntry.name}'s score of ${formatScore(scoreEntry.score)} in ${scoreEntry.challengeName}` : 'Unknown Score';

                try {
                    await scoreDocRef.delete();
                    setStatus(`Successfully removed score entry: ${scoreDisplay}.`);
                    setSelectedScoreIdToDelete('');
                } catch (error) {
                    console.error("Error deleting score:", error);
                    setStatus(`Error removing score: ${error.message}`, true);
                }
            };


            return (
                <div className="w-full max-w-7xl p-4 md:p-8 bg-gray-800/80 backdrop-blur-sm rounded-xl shadow-2xl text-white space-y-8">
                    <h2 className="text-3xl font-extrabold text-blue-400 border-b border-blue-500/50 pb-2 flex items-center">
                        <svg className="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.996.608 2.222.08 2.573-1.066z"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Admin Panel - Management Tools
                    </h2>

                    {loading ? <LoadingSpinner /> : (
                        <>
                            {/* Status/Error Message Display */}
                            {(message || error) && (
                                <div className={`p-3 rounded mb-4 text-center font-semibold animate-pulse ${error ? 'bg-red-600' : 'bg-green-600'}`}>
                                    {message || error}
                                </div>
                            )}

                            {/* GRID LAYOUT: Uses md:grid-cols-2 for tablet+ layout */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* COLUMN 1: ADDITION FORMS */}
                                <div className="space-y-6">
                                    {/* 1. Add Challenge Section */}
                                    <div className="border border-gray-600 p-4 rounded-lg bg-gray-700/30">
                                        <h3 className="text-xl font-bold mb-3 text-blue-300">1. Define New Challenge (Add)</h3>
                                        <form onSubmit={handleAddChallenge} className="flex flex-col gap-4">
                                            <label htmlFor="category-select-admin-add" className="block text-sm font-medium text-gray-400">Select Category</label>
                                            <select
                                                id="category-select-admin-add"
                                                value={newChallengeCategory}
                                                onChange={(e) => setNewChallengeCategory(e.target.value)}
                                                className="p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white"
                                                required
                                                disabled={loading}
                                            >
                                                {categoryOptions}
                                            </select>
                                            <input
                                                type="text"
                                                placeholder="Challenge Name (e.g., Courchevel Landing)"
                                                value={newChallengeName}
                                                onChange={(e) => setNewChallengeName(e.target.value)}
                                                className="p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white"
                                                required
                                                disabled={loading}
                                            />
                                            <input
                                                type="text"
                                                placeholder="Airport Code (e.g., LFLJ)"
                                                value={newChallengeAirport}
                                                onChange={(e) => setNewChallengeAirport(e.target.value)}
                                                className="p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white"
                                                required
                                                disabled={loading}
                                            />
                                            <button
                                                type="submit"
                                                className="w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md transition duration-150 shadow-md disabled:opacity-50"
                                                disabled={loading || !newChallengeName.trim() || !newChallengeAirport.trim() || !newChallengeCategory}
                                            >
                                                Create Challenge
                                            </button>
                                        </form>
                                    </div>

                                    {/* 2. Add Pilot Section */}
                                    <div className="border border-gray-600 p-4 rounded-lg bg-gray-700/30">
                                        <h3 className="text-xl font-bold mb-3 text-gray-200">2. Add New Pilot (Add)</h3>
                                        <form onSubmit={handleAddStudent} className="flex flex-col sm:flex-row gap-4">
                                            <input
                                                type="text"
                                                placeholder="Student Name / Pilot Callsign"
                                                value={newStudentName}
                                                onChange={(e) => setNewStudentName(e.target.value)}
                                                className="flex-grow p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-emerald-500 focus:border-emerald-500 text-white"
                                                required
                                                disabled={loading}
                                            />
                                            <button
                                                type="submit"
                                                className="w-full sm:w-auto px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-md transition duration-150 shadow-md disabled:opacity-50"
                                                disabled={loading || !newStudentName.trim()}
                                            >
                                                Add Pilot
                                            </button>
                                        </form>
                                    </div>

                                    {/* 3. Upload Score Section */}
                                    <div className="border border-gray-600 p-4 rounded-lg bg-gray-700/30">
                                        <h3 className="text-xl font-bold mb-3 text-gray-200">3. Upload New Landing Score (Add)</h3>
                                        <form onSubmit={handleAddScore} className="space-y-4">
                                            {/* Challenge Selector */}
                                            <div>
                                                <label htmlFor="challenge-select-add" className="block text-sm font-medium text-gray-400 mb-1">Select Specific Challenge</label>
                                                <select
                                                    id="challenge-select-add"
                                                    value={selectedChallengeId}
                                                    onChange={(e) => setSelectedChallengeId(e.target.value)}
                                                    className="w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white"
                                                    required
                                                    disabled={loading || challenges.length === 0}
                                                >
                                                    <option value="" disabled>-- Choose a challenge --</option>
                                                    {challengeOptions}
                                                </select>
                                                {challenges.length === 0 && !loading && (
                                                    <p className="text-sm text-red-400 mt-2">No challenges defined. Please create one in Section 1.</p>
                                                )}
                                            </div>

                                            {/* Pilot Selector */}
                                            <div>
                                                <label htmlFor="student-select-add" className="block text-sm font-medium text-gray-400 mb-1">Select Pilot</label>
                                                <select
                                                    id="student-select-add"
                                                    value={selectedStudentId}
                                                    onChange={(e) => setSelectedStudentId(e.target.value)}
                                                    className="w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-emerald-500 focus:border-emerald-500 text-white"
                                                    required
                                                    disabled={loading || students.length === 0}
                                                >
                                                    <option value="" disabled>-- Choose a pilot --</option>
                                                    {studentOptions}
                                                </select>
                                                {students.length === 0 && !loading && (
                                                    <p className="text-sm text-red-400 mt-2">No pilots available. Please add a pilot in Section 2.</p>
                                                )}
                                            </div>

                                            {/* Score Input */}
                                            <div>
                                                <label htmlFor="score-input-add" className="block text-sm font-medium text-gray-400 mb-1">Landing Score (e.g., 985000)</label>
                                                <input
                                                    id="score-input-add"
                                                    type="number"
                                                    placeholder="Enter score"
                                                    value={newScore}
                                                    onChange={(e) => setNewScore(e.target.value)}
                                                    className="w-full p-3 rounded-md bg-gray-700 border border-gray-600 focus:ring-emerald-500 focus:border-emerald-500 text-white font-mono"
                                                    required
                                                    min="1"
                                                    disabled={loading || !selectedStudentId || !selectedChallengeId}
                                                />
                                            </div>
                                            <button
                                                type="submit"
                                                className="w-full px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-md transition duration-150 shadow-md disabled:opacity-50"
                                                disabled={loading || !selectedStudentId || !selectedChallengeId || !newScore || parseInt(newScore) <= 0}
                                            >
                                                Submit Score
                                            </button>
                                        </form>
                                    </div>
                                </div>

                                {/* COLUMN 2: DELETION FORMS - Already using md:grid-cols-2 from last update */}
                                <div className="space-y-6">
                                    
                                    {/* 4. Remove Challenge Section */}
                                    <div className="border border-red-600 p-4 rounded-lg bg-red-900/20">
                                        <h3 className="text-xl font-bold mb-3 text-red-300">4. Remove Challenge (Delete)</h3>
                                        <form onSubmit={handleDeleteChallenge} className="space-y-4">
                                            <label htmlFor="challenge-select-del" className="block text-sm font-medium text-gray-400">Select Challenge to Remove</label>
                                            <select
                                                id="challenge-select-del"
                                                value={selectedChallengeIdToDelete}
                                                onChange={(e) => setSelectedChallengeIdToDelete(e.target.value)}
                                                className="w-full p-3 rounded-md bg-gray-700 border border-red-600 focus:ring-red-500 focus:border-red-500 text-white"
                                                required
                                                disabled={loading || challenges.length === 0}
                                            >
                                                <option value="" disabled>-- Choose a challenge --</option>
                                                {challengeOptions}
                                            </select>
                                            <button
                                                type="submit"
                                                className="w-full px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-md transition duration-150 shadow-md disabled:opacity-50"
                                                disabled={loading || challenges.length === 0 || !selectedChallengeIdToDelete}
                                            >
                                                Delete Challenge
                                            </button>
                                        </form>
                                    </div>

                                    {/* 5. Remove Pilot Section */}
                                    <div className="border border-red-600 p-4 rounded-lg bg-red-900/20">
                                        <h3 className="text-xl font-bold mb-3 text-red-300">5. Remove Pilot (Delete)</h3>
                                        <form onSubmit={handleDeleteStudent} className="space-y-4">
                                            <label htmlFor="student-select-del" className="block text-sm font-medium text-gray-400">Select Pilot to Remove</label>
                                            <select
                                                id="student-select-del"
                                                value={selectedStudentIdToDelete}
                                                onChange={(e) => setSelectedStudentIdToDelete(e.target.value)}
                                                className="w-full p-3 rounded-md bg-gray-700 border border-red-600 focus:ring-red-500 focus:border-red-500 text-white"
                                                required
                                                disabled={loading || students.length === 0}
                                            >
                                                <option value="" disabled>-- Choose a pilot --</option>
                                                {studentOptions}
                                            </select>
                                            <button
                                                type="submit"
                                                className="w-full px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-md transition duration-150 shadow-md disabled:opacity-50"
                                                disabled={loading || students.length === 0 || !selectedStudentIdToDelete}
                                            >
                                                Delete Pilot
                                            </button>
                                        </form>
                                    </div>

                                    {/* 6. Remove Score Section */}
                                    <div className="border border-red-600 p-4 rounded-lg bg-red-900/20">
                                        <h3 className="text-xl font-bold mb-3 text-red-300">6. Remove Score Entry (Delete)</h3>
                                        <form onSubmit={handleDeleteScore} className="space-y-4">
                                            <label htmlFor="score-select-del" className="block text-sm font-medium text-gray-400">Select Specific Score Entry to Remove</label>
                                            <select
                                                id="score-select-del"
                                                value={selectedScoreIdToDelete}
                                                onChange={(e) => setSelectedScoreIdToDelete(e.target.value)}
                                                className="w-full p-3 rounded-md bg-gray-700 border border-red-600 focus:ring-red-500 focus:border-red-500 text-white"
                                                required
                                                disabled={loading || scores.length === 0}
                                            >
                                                <option value="" disabled>-- Choose a score entry --</option>
                                                {sortedScores.map(s => (
                                                    <option key={s.id} value={s.id}>
                                                        {s.name} | {s.challengeName} | {formatScore(s.score)} ({new Date(s.timestamp?.seconds * 1000).toLocaleDateString()})
                                                    </option>
                                                ))}
                                            </select>
                                            <button
                                                type="submit"
                                                className="w-full px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-md transition duration-150 shadow-md disabled:opacity-50"
                                                disabled={loading || scores.length === 0 || !selectedScoreIdToDelete}
                                            >
                                                Delete Score Entry
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </>
                    )}
                </div>
            );
        };
        
        // --- Admin Login Wrapper (Temporary Password Check) ---
        const AdminLogin = ({ onLogin }) => {
            // WARNING: This is a client-side password only for demonstration.
            // For real security, implement role-based authentication using Firebase Auth and Security Rules.
            const ADMIN_PASSWORD = "AngleofAttack";
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (password === ADMIN_PASSWORD) {
                    onLogin(true);
                    setError('');
                } else {
                    setError('Incorrect password. Access denied.');
                    setPassword('');
                }
            };

            return (
                <div className="w-full max-w-md p-8 bg-gray-800/80 backdrop-blur-sm rounded-xl shadow-2xl text-white space-y-6">
                    <h2 className="text-3xl font-extrabold text-blue-400 text-center">Admin Login</h2>
                    <p className="text-gray-400 text-center">Enter the administrator password to access management tools.</p>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <input
                            type="password"
                            placeholder="Password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            className="w-full p-4 rounded-md bg-gray-700 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white"
                            required
                        />
                        {error && <p className="text-red-400 text-center text-sm">{error}</p>}
                        <button
                            type="submit"
                            className="w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md transition duration-150 shadow-md"
                        >
                            Log In
                        </button>
                    </form>
                </div>
            );
        };
        
        const AdminView = (props) => {
            const [isAdminLoggedIn, setIsAdminLoggedIn] = useState(false);
            
            if (!isAdminLoggedIn) {
                // Temporary simple password lock
                return <AdminLogin onLogin={setIsAdminLoggedIn} />;
            }
            
            // If logged in, show the content.
            return <AdminViewContent {...props} />;
        };


        const App = () => {
            const [view, setView] = useState('leaderboard'); 
            
            // Centralized Firebase setup via custom hook
            const { db, auth, userId, isAuthReady } = useFirebaseSetup();
            
            // Data fetching hook depends on successful Firebase/Auth initialization
            const { students, scores, challenges, loading: dataLoading } = useFirestoreData(db, auth, userId);

            const loading = !isAuthReady || dataLoading;
            
            // --- Configuration Check ---
            if (firebaseConfig.projectId.includes("REPLACE_WITH")) {
                return (
                    <div className="min-h-screen bg-gray-900 font-sans text-gray-100 p-4 flex flex-col items-center justify-center">
                        <div className="w-full max-w-7xl p-8 bg-red-900/50 backdrop-blur-sm rounded-xl shadow-2xl text-center">
                            <h2 className="text-3xl font-extrabold mb-4 text-red-300">Configuration Error</h2>
                            <p className="text-lg text-red-200">
                                The Firebase configuration keys are missing. Please edit the **index.html** file around line 40 and replace all placeholder values with your actual Firebase project configuration.
                            </p>
                            <footer className="mt-8 text-center text-xs text-gray-500">
                                <p>Current User ID: {userId || 'Authenticating...'}</p>
                            </footer>
                    </div>
                    </div>
                );
            }
            // --- End Configuration Check ---

            return (
                <div className="min-h-screen bg-gray-900 font-sans text-gray-100 p-4 flex flex-col items-center w-full">
                    
                    {/* Header and Navigation */}
                    <header className="w-full max-w-7xl mb-8">
                        <h1 className="text-4xl font-black text-center text-white p-4">
                            <span className="text-3c4785-400">Flight Sim</span> Score Tracker
                        </h1>
                        <div className="flex justify-center space-x-4">
                            <button
                                onClick={() => setView('leaderboard')}
                                className={`px-6 py-2 rounded-full font-semibold transition duration-200 ${
                                    view === 'leaderboard'
                                        ? 'bg-emerald-600 text-white shadow-lg'
                                        : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                }`}
                            >
                                Leaderboards Overview
                            </button>
                            <button
                                onClick={() => setView('admin')}
                                className={`px-6 py-2 rounded-full font-semibold transition duration-200 ${
                                    view === 'admin'
                                        ? 'bg-blue-600 text-white shadow-lg'
                                        : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                }`}
                            >
                                Admin Panel (Secured)
                            </button>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="w-full flex justify-center flex-grow">
                        {loading ? (
                            <LoadingSpinner />
                        ) : (
                            view === 'leaderboard' ? (
                                <LeaderboardsView
                                    students={students}
                                    scores={scores}
                                    challenges={challenges}
                                    loading={dataLoading}
                                />
                            ) : (
                                <AdminView 
                                    db={db} 
                                    userId={userId} 
                                    students={students} 
                                    scores={scores}
                                    challenges={challenges} 
                                    loading={dataLoading} 
                                />
                            )
                        )}
                    </main>

                    {/* Footer / Debug Info */}
                    <footer className="mt-8 text-center text-xs text-gray-500 max-w-7xl w-full">
                        <p>App ID: {appId}</p>
                        <p>Current User ID: {userId || 'Authenticating...'}</p>
                    </footer>
                </div>
            );
        };
        
        // Final render call
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
    
    <!-- IMPORTANT: Firebase CDN scripts must be loaded for the app to function -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</body>
</html>
